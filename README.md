# MyNovelBot

欢迎来到 MyNovelBot 项目！这是一个可高度定制的、功能强大的 AI 角色扮演聊天机器人。

## 核心架构 (v0.2+)

本项目已经完成了一次重大的架构升级，从早期的文件系统存储演进为一个现代化的、数据库驱动的前后端分离 Web 应用。

*   **后端**: 基于 **Python 3.13** 和 **FastAPI** 构建，提供高性能的异步 API 服务。
*   **前端**: 基于 **Nuxt.js 3** (Vue 3) 构建，提供流畅、响应迅速的用户界面。
*   **数据库**: 默认使用 **SQLite** 实现真正的“开箱即用”，所有用户数据（角色卡、聊天记录等）都安全地存储在本地的 `mynovelbot.db` 文件中。同时支持一键切换到 **PostgreSQL** 以满足生产环境部署的需求。
*   **依赖管理**: 后端使用 **Poetry**，前端使用 **pnpm**，确保了开发环境的一致性和稳定性。

## 未来展望：向原生桌面应用转型

为了提供更极致的用户体验、保证数据绝对私密并简化分发流程，**本项目已规划向一个基于 Tauri + Rust + Nuxt.js + SQLite 技术的原生桌面应用程序转型。**

**核心目标：**

*   **开箱即用：** 最终版本将是一个无需用户自行配置任何环境、双击即可运行的桌面应用。
*   **数据私密：** 所有用户数据将继续安全地存储在本地的 SQLite 数据库文件中。
*   **性能提升：** 利用 Rust 的高性能后端和 Tauri 的原生 Webview，应用将更加流畅、响应更迅速。
*   **深度集成：** 未来将利用 Tauri 的能力，实现文件拖拽、系统通知等更深度的操作系统集成功能。

**请注意：**
以下文档描述的是当前 **Python + Nuxt.js** Web 服务阶段的安装和使用方法。

---

## 1. 快速开始 (Windows)

在开始之前，请先运行环境自检脚本，以确保您的系统满足所有要求。

**`check_environment.ps1`**
*   **使用方法**：在文件资源管理器中，右键点击 `check_environment.ps1`，选择“使用 PowerShell 运行”。

*   ✅ 如果所有检查项都显示 **[通过]**，您可以直接跳转到 **[第3步：安装项目依赖](#3-安装项目依赖)**。
*   ❌ 如果任何一项检查显示 **[失败]**，请从下面的 **[第2步：环境安装指南](#2-环境安装指南)** 开始，并严格按照指引操作。

---

## 2. 环境安装指南

本指南将帮助您配置一个与开发者完全一致的环境，以最大程度地避免潜在问题。

### 软件版本总览

| 软件/工具 | 推荐版本 | 用途 |
| :--- | :--- | :--- |
| **NVM for Windows** | `1.2.2` | 管理 Node.js 版本 |
| **Node.js** | `v24.7.0` | 前端运行环境 |
| **pnpm** | `10.15.1` | 前端包管理器 |
| **Python** | `3.13.0` | 后端运行环境 |
| **Poetry** | `最新版` | 后端包管理器 |

---

### 2.1 安装 NVM for Windows (Node版本管理器)

1.  **下载**: 打开下面的链接，下载 `nvm-setup.exe` 安装包。
    *   **下载地址**: [https://github.com/coreybutler/nvm-windows/releases/tag/1.2.2](https://github.com/coreybutler/nvm-windows/releases/tag/1.2.2)

2.  **安装**:
    *   双击运行 `nvm-setup.exe`。
    *   在安装过程中，您可以直接使用默认的安装路径，一路点击“下一步”即可。

3.  **验证**:
    *   **完全关闭** 您当前的终端/命令行窗口，然后**重新打开一个新的**。
    *   在新窗口中输入 `nvm version`，如果屏幕上显示 `1.2.2`，则表示安装成功。

### 2.2 安装 Node.js 和 pnpm

1.  **安装 Node.js**: 在新打开的终端中输入以下命令，NVM 会自动下载并安装 v24.7.0。
    ```bash
    nvm install 24.7.0
    ```

2.  **使用 Node.js**: 输入以下命令，让 NVM 将当前环境切换到 v24.7.0。
    ```bash
    nvm use 24.7.0
    ```

3.  **安装 pnpm**: Node.js 安装成功后，会自动附带 `npm`。我们使用 `npm` 来安装指定版本的 `pnpm`。
    ```bash
    npm install -g pnpm@10.15.1
    ```

4.  **验证**:
    *   输入 `node -v`，应显示 `v24.7.0`。
    *   输入 `pnpm -v`，应显示 `10.15.1`。

### 2.3 安装 Python

1.  **下载**: 打开下面的链接，为您的系统下载 Python 3.13.0 的安装包（推荐 Windows Installer 64-bit）。
    *   **下载地址**: [https://www.python.org/downloads/release/python-3130/](https://www.python.org/downloads/release/python-3130/)

2.  **安装**:
    *   双击运行下载的 `.exe` 文件。
    *   在安装界面的第一步，**务必勾选 `Add python.exe to PATH`** 这个选项。
    *   然后点击 `Install Now`，等待安装完成。

3.  **验证**:
    *   打开一个新的终端/命令行窗口。
    *   输入 `python --version`，应显示 `Python 3.13.0`。

### 2.4 安装 Poetry

1.  **安装**:
    *   确保您的 Python 已正确安装并已添加到 PATH。
    *   打开一个新的终端/命令行窗口，输入以下命令通过 pip 安装 Poetry：
        ```bash
        pip install poetry
        ```

2.  **配置环境变量**:
    *   Poetry 安装后，需要将其执行路径手动添加到系统 PATH 中。
    *   在 Windows 搜索框中，搜索“编辑账户的环境变量”并打开它。
    *   在“用户变量”区域，找到名为 `Path` 的变量，选中它，然后点击“编辑”。
    *   在弹出的窗口中，点击“新建”，然后粘贴以下路径（请将 `YourUsername` 替换为您自己的 Windows 用户名）：
        ```
        C:\Users\YourUsername\AppData\Roaming\Python\Python313\Scripts
        ```
    *   一路点击“确定”保存所有窗口。

3.  **验证**:
    *   **完全关闭并重新打开**一个新的终端窗口。
    *   输入 `poetry --version`，如果能显示版本号，则表示配置成功。

---

## 3. 安装项目依赖

当您确认 `check_environment.ps1` 的所有检查都通过后，就可以安装项目自身的前后端依赖了。

在项目根目录下，双击运行：
**`install_dependencies.bat`**

这个脚本会自动为前端 (`web-ui`) 和后端 (`novel_bot`) 分别安装所有必需的依赖包。

---

## 4. 首次运行配置 (数据库)

本项目为了实现开箱即用，默认使用 **SQLite** 数据库。

*   **无需任何配置**：当您首次启动项目时，会在 `novel_bot/data/` 目录下自动创建一个名为 `mynovelbot.db` 的数据库文件，所有数据都将存储在这里。

### 可选：切换到 PostgreSQL

如果您需要更强大的性能或计划将应用部署到服务器，可以选择使用 PostgreSQL。

1.  **准备 PostgreSQL 服务**:
    *   您需要一个正在运行的 PostgreSQL 数据库实例。

2.  **修改配置文件**:
    *   打开项目中的 `novel_bot/config.toml` 文件。
    *   找到 `[database]` 部分，将 `db_type` 的值从 `"sqlite"` 修改为 `"postgres"`。
    *   在 `[database.postgres]` 部分，填入您自己的数据库连接 `url`。

3.  **启动项目**:
    *   正常启动项目即可。后端程序会自动检测到配置变更并连接到您的 PostgreSQL 数据库。

---

## 5. 运行项目

所有配置和依赖安装完成后，您可以选择以下任一方式启动项目：

*   **开发模式**: `dev.bat`
    *   启动所有服务，并开启前端的热更新功能，适合进行代码修改和调试。
*   **稳定模式**: `run_stable.bat`
    *   启动预先构建好的稳定版前端，性能更佳，适合日常使用。

祝您使用愉快！

---

## 6. 从旧版文件系统备份迁移数据

如果您是 `v0.1.x` 等旧版本的用户，并希望将您的数据（角色卡、聊天记录等）迁移到新的数据库系统中，请遵循以下步骤。

1.  **准备备份文件:**
    *   在项目根目录下，创建一个名为 `tools` 的文件夹（如果不存在）。
    *   在 `tools` 文件夹内，再创建一个名为 `legacy_backup` 的文件夹。
    *   将您旧版本项目中的整个 `ai_chat` 文件夹，完整地复制到 `legacy_backup` 文件夹中。
    *   完成后，您的目录结构应如下所示：
        ```
        MyNovelBot/
        ├── tools/
        │   └── legacy_backup/
        │       └── ai_chat/      <-- 这是您复制过来的旧数据文件夹
        │           ├── public/
        │           ├── users/
        │           └── ...
        └── ...
        ```

2.  **运行迁移脚本:**
    *   在项目的**根目录**下，双击运行 `tools/run_migration.bat` 脚本。

3.  **验证结果:**
    *   脚本执行成功后，会在 `MyNovelBot/novel_bot/data/` 目录下生成一个名为 `mynovelbot.db` 的文件。这个文件就是包含了您所有旧数据的新数据库。
    *   现在，您可以正常启动项目，它将自动加载这个新的数据库文件。

---
## 7. 脚本使用指南

本项目提供了一系列 `.bat` 和 `.ps1` 脚本来自动化常见任务。

### 脚本功能速查

| 脚本文件 | 功能描述 |
| :--- | :--- |
| **`check_environment.ps1`** | **环境自检 (第一步)**：检查所有核心开发工具的版本是否符合要求。 |
| **`install_dependencies.bat`** | **安装依赖**：为前端和后端安装所有必需的依赖包。 |
| **`dev.bat`** | **启动开发者模式**：启动所有服务，并为前端开启实时热更新，适合开发和调试。 |
| **`run_stable.bat`** | **启动稳定模式**：启动后端服务和预先构建好的稳定版前端，性能更优，适合日常使用。 |
| **`build.bat`** | **构建稳定版前端**：将前端代码打包成静态文件，供 `run_stable.bat` 使用。 |
| **`clean_wizard.bat`** | **清理向导**：一个强大的清理工具，可以清理缓存、依赖包和其他临时文件。 |
| **`tools/run_migration.bat`** | **运行数据迁移**：从 `tools/legacy_backup` 目录迁移旧版数据到新数据库。 |
| **`tools/run_db_toolkit.bat`** | **数据库工具箱**：启动一个交互式的命令行工具，用于查看、诊断和修复数据库。 |

### 推荐使用流程

#### 场景一：首次安装项目

1.  **环境检查**: 右键点击 `check_environment.ps1`，选择“使用 PowerShell 运行”，确保所有项目都 **[通过]**。如有失败项，请严格按照本 `README` 文件 **第2节** 的指南手动安装。
2.  **安装依赖**: 双击运行 `install_dependencies.bat`。
3.  **开始使用**:
    *   作为开发者，双击 `dev.bat` 启动。
    *   作为普通用户，双击 `run_stable.bat` 启动。

#### 场景二：遇到错误或需要深度清理

1.  **运行清理向导**: 双击 `clean_wizard.bat`。
2.  **选择清理选项**: 根据提示，选择您需要的清理级别。通常，“一键执行安全清理”(选项A)可以解决大部分问题。
3.  **重新安装依赖**: 清理完成后，再次运行 `install_dependencies.bat`。
4.  **重新启动**: 尝试再次运行 `dev.bat` 或 `run_stable.bat`。

---
## 8. 开发者须知：请谨慎修改配置文件
本项目的配置文件（如 `novel_bot/pyproject.toml` 和 `web-ui/nuxt.config.ts`）经过了精心的调整，以确保跨环境的兼容性和稳定性。我们强烈建议您在不完全理解其背后原因的情况下，不要随意修改这些文件中的配置。

**一个具体的例子：**

您可能会注意到 `novel_bot/pyproject.toml` 文件中有一行 `requires-python = ">=3.9, <4.0"`。

这并非随意设置的。在早期的配置中，这里可能是一个更宽泛的版本（如 `>3.8`）。然而，这会导致 `poetry` 在安装核心依赖 `nonebot2` 时出现版本冲突，因为 `nonebot2` 的新版本要求 Python 3.9 或更高。

因此，将 Python 版本精确地限制在 `>=3.9` 是为了**解决一个已知的、具体的依赖安装问题**，是确保项目能成功安装的关键一步。

同样，项目中的许多其他配置，例如文件路径、依赖版本号、脚本命令等，都有其存在的具体原因。随意修改很可能导致程序无法运行。

如果您遇到问题，请优先遵循 **[第7节的脚本使用指南](#7-脚本使用指南)** 中的清理和重装流程，而不是尝试修改配置文件。